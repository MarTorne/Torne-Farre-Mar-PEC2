---
title: "PAC 2"
author: "Mar Torné Farré"
date: "2025-05-05"
output:
  word_document:
    toc: true
    toc_depth: '3'
  pdf_document:
    toc: true
    toc_depth: '3'
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    collapsed: true
    smooth_scroll: true
    theme: cerulean
    highlight: tango
    df_print: paged
    code_folding: show
---


# Resum

### Estudi anàlisi d'expressió gènica diferencial en R/Bioconductor a partir del dataset GSE161731

Iniciarem l'estudi fent una revisió de l'estudi **Dysregulated transcriptional responses to SARS-CoV-2 in the periphery support novel diagnostic approaches** identificat amb el codi GSE161731 a la página de **Gene Expression Omnibus** (https://www.ncbi.nlm.nih.gov/geo/). 

Per tal de trobar nous aspectes de la resposta de l'hoste al SARS-CoV-2, l'estudi va realitzar la seqüenciació d'ARN en 77 mostres de sang perifèrica de 46 subjectes amb COVID-19 i les va comparar amb subjectes amb coronavirus estacional, grip, pneumònia bacteriana i controls sans. El transcriptoma de la sang perifèrica revela aspectes únics de la resposta immunitària a la COVID-19 i proporciona nous enfocaments de diagnòstic basats en biomarcadors. 

En el diseny de l'estudi per definir la resposta transcripcional de la sang perifèrica de l'hoste en subjectes amb infecció per SARS-CoV-2, es va realitzar la seqüenciació d'ARN en mostres de 46 individus amb infecció per SARS-CoV-2 simptomàtica i amb PCR positiva, 14 dels quals es van mostrejar en múltiples moments. Els subjectes es van inscriure quan es van presentar per a atenció clínica i es va registrar el temps des de l'aparició dels símptomes per a cada mostra individual recollida (rang 1-35 dies). Els subjectes amb COVID-19 es van dividir en funció de la gravetat de la malaltia i el temps des de l'aparició dels símptomes (inici ≤10 dies, mitjans 11-21 dies, final >21 dies). Com a comparadors, es van perfilar mostres de sang emmagatzemades de pacients que es presentaven al Servei d'Urgències amb infecció respiratòria aguda (IRA) a causa de coronavirus estacional (n=59), grip (n=17) o pneumònia bacteriana (n=20), i controls sans coincidents (n=19).


# Objectiu

L'estudi té com a objectiu investigar els canvis 

En aquest treball, realitzarem un anàlisi exploratòria que ens proporcioni una visió general del dataset. Per fer-ho, crearem un objecte de classe **SummarizedExperiment**, que contingui les dades i les metadades de l'estudi i durem a terme processos de depuració, filtratge i revisió del dataset.


# Mètodes

L'estudi està disponible a **Metabolomics Workbench** (https://www.metabolomicsworkbench.org/), amb el número d'estudi ST00029.

A més, també es pot trobar al repositori **GitHub** (https://github.com/nutrimetabolomics/metaboData.git), dins la carpeta **Datasets/2024-fobitools-UseCase_1**.




# Resultats

### Descàrrega del dataset GSE161731

A la pàgina de GEO hi trobem diferent informació diversa sobre l'estudi. En l'apartat **Downloas RNA-seq counts** hi trobem els següents fitxers:

_Fitxers proporcionats pels autors_:

  •	Series SOFT file (GSE161731_family.soft.gz) - Fitxer en format SOFT que conté les metadades de la sèrie, com ara informació sobre l'estudi, les mostres, els protocols utilitzats, els processos i anàlisis utilitzats...
  
  •	Series MINiML file (GSE161731_family.xml.tgz) - Fitxer en format XML que conté les metadades de la sèrie, com ara informació sobre l'estudi, les mostres, els protocols utilitzats, els processos i anàlisis utilitzats...
  
  REVISSSSAAARR•	Series Matrix file (GSE161731_series_matrix.txt.gz) - Fitxer tabular de GEO amb l’expressió gènica normalitzada o els valors processats per mostra. Són fitxers de text que inclouen una matriu de valors delimitada per tabulacions, generada a partir de la columna "VALUE" de cada mostra i encapçalada per les metadades de la sèrie.

_Fitxers suplementaris_:

  •	GSE161731_counts.csv.gz - Fitxer de format CSV amb la matriu de comptatges bruts de gens per mostra. Conté el nombre de lectures (reads) assignades a cada gen.
  
  •	GSE161731_counts_key.csv.gz - Fitxer de format CSV associat al fitxer de comptatges, amb el diccionari de les mostres. Conté 198 registres, és a dir, les claus de la matiu de dades. Aquestes claus serveixen per identificar les mostres a les matrius de comptatges.
  
  •	GSE161731_key.csv.gz - Fitxer de format CSV amb el diccionari de les mostres. Conté 196 registres, és a dir les claus úniques. Aquestes claus serveixen per identificar les mostres a les matrius de comptatges.
  
  •	GSE161731_xpr_nlcpm.csv.gz - Expressions normalitzades en log2 counts per milió (logCPM). 
  
  •	GSE161731_xpr_tpm_geo.txt.gz - Expressions en TPM (Transcripts Per Million).

_Fitxers NCBI - Generats automàticament per GEO_

  •	GSE161731_raw_counts_GRCh38.p13_NCBI.tsv.gz - Matriu de comptatges bruts per gen i per mostra, alineats contra el genoma de referència GRCh38.p13.
  
  •	GSE161731_norm_counts_FPKM_GRCh38.p13_NCBI.tsv.gz - Matriu de comptatges normalitzats en FPKM (Fragments Per Kilobase Million).
  
  •	GSE161731_norm_counts_TPM_GRCh38.p13_NCBI.tsv.gz - Matriu de comptatges normalitzats en TPM (Transcripts Per Million).

  •	Human.GRCh38.p13.annot.tsv.gz - Taula d’anotació de gens utilitzada per GEO per etiquetar els gens de les matrius anteriors. Conté informació com l’identificador del gen, nom del gen, coordenades al genoma, tipus de gen, ... 


```{r,eval=TRUE,echo=FALSE}
# Instal·lem Bioconductor 
if (!require(BiocManager)){
  install.packages("BiocManager",dep=TRUE)}

# Definim la funcio installifnot
installifnot<-function(pckgName,BioC=TRUE){
  if (BioC){
    if (!require(pckgName,character.only=TRUE)){
      BiocManager::install(pckgName)}
  } else {
    if (!require(pckgName,character.only=TRUE)){
      install.packages(pckgName,dep=TRUE)}
  }
}

# Carreguem els paquets que necessitarem
installifnot("GEOquery")
installifnot("SummarizedExperiment") # Deixar
installifnot("EnsDb.Hsapiens.v86") # Deixar
installifnot("GenomicRanges") # Deixar
installifnot("AnnotationDbi")
installifnot("org.Hs.eg.db")
installifnot("S4Vectors")

# Creem els directoris del repositori
if (!dir.exists("dades")) dir.create("dades")
if (!dir.exists("resultats")) dir.create("resultats")
if (!dir.exists("figures")) dir.create("figures")

dir_treball<-getwd()
dir_dades<-file.path(dir_treball,"dades")
dir_resultats<-file.path(dir_treball,"resultats")

# Guardem els fitxers al repositori- PROVAR perque ara mateix no funciona
if (!file.exists(file.path(dir_dades,"GSE161731_counts.csv.gz"))){
  download.file("https://ftp.ncbi.nlm.nih.gov/geo/series/GSE161nnn/GSE161731/suppl/GSE161731%5F#counts.csv.gz",destfile=file.path(dir_dades,"GSE161731_counts.csv.gz"))
}

if (!file.exists(file.path(dir_dades,"GSE161731_counts_key.csv.gz"))){
  download.file("https://www.ncbi.nlm.nih.gov/geo/download/?acc=GSE161731&format=file&file=GSE1#61731%5Fcounts%5Fkey%2Ecsv%2Egz",destfile=file.path(dir_dades,"GSE161731_counts_key.csv.gz"))
}

if (!file.exists(file.path(dir_dades,"GSE161731_key.csv.gz"))){
  download.file("https://www.ncbi.nlm.nih.gov/geo/download/?acc=GSE161731&format=file&file=GSE1#61731%5Fkey%2Ecsv%2Egz",destfile=file.path(dir_dades,"GSE161731_key.csv.gz"))
}
```

```{r,eval=TRUE,echo=FALSE}
# Obtenir l'estudi GEO
#gse<-getGEO("GSE161731",GSEMatrix=TRUE)

# Revisem la informació que conté cada fitxer
counts<-read.csv(file.path(dir_dades,"GSE161731_counts.csv.gz"),row.names=1,check.names=FALSE)
counts_key<-read.csv(file.path(dir_dades,"GSE161731_counts_key.csv.gz"))
meta<-read.csv(file.path(dir_dades,"GSE161731_key.csv.gz"))
head(counts_key)
head(meta)
dim(counts_key)
dim(meta)
colnames(counts_key)
colnames(meta)
table(duplicated(counts_key$rna_id)) # Comprovem si hi ha mostres duplicades
table(duplicated(counts_key$subject_id)) # Comprovem si hi ha mostres duplicades
table(counts_key$subject_id)

# Revisem que puguem construïr bé el SummarizedExperiment
rownames(counts_key)<-counts_key$rna_id
all(colnames(counts) %in% rownames(counts_key)) # Comprovem que coincideixen
setdiff(colnames(counts),rownames(counts_key))

# Comprovem si a count tenim duplicats
mostres_batch2<-c("DU09-02S0000150_batch2","DU09-02S0000154_batch2","DU09-02S0000158_batch2")
mostres_batch2_suprimides<-gsub("_batch2","",mostres_batch2)
resultats<-mostres_batch2_suprimides %in% colnames(counts)
resultats
counts<-counts[,!colnames(counts) %in% c("DU09-02S0000150_batch2","DU09-02S0000154_batch2","DU09-02S0000158_batch2")] # Suprimim 3 duplicats

# Construïm SummarizedExperiment
SE_GSE161731<-SummarizedExperiment(assays=list(counts=as.matrix(counts)),colData=DataFrame(counts_key))
SE_GSE161731
saveRDS(SE_GSE161731,file=file.path(dir_resultats,"DatasetGSE161731.rds"))

# Agreguem les coordenades gèniques
coord_gens<-genes(EnsDb.Hsapiens.v86,filter=GeneIdFilter(rownames(SE_GSE161731)))
#rowRanges(SE_GSE161731)<-coord_gens # Tenim 60675 files a la matriu d'expressió i 57602 gens 
gens_comuns<-intersect(rownames(SE_GSE161731),coord_gens$gene_id) # Seleccionem els gens amb coordenades disponibles
SE_GSE161731<-SE_GSE161731[gens_comuns,] # Subconjunt de la matriu d'expressió i les coordenades coincidents
coord_gens_filtrat<-coord_gens[match(gens_comuns,coord_gens$gene_id)]
rowRanges(SE_GSE161731) <- coord_gens_filtrat # Assignem les rowRanges

# Gravem SummarizedExperiment
saveRDS(SE_GSE161731,file=file.path(dir_resultats,"DatasetGSE161731.rds"))
```

```{r,eval=TRUE,echo=FALSE}
# Netegem counts_key i seleccionem només les cohorts: COVID19, Bacterial i healthy
rna_ids_sel<-counts_key$rna_id[counts_key$cohort %in% c("COVID-19","Bacterial","healthy")]
SE_GSE161731<-SE_GSE161731[,colnames(SE_GSE161731) %in% rna_ids_sel]
table(colData(SE_GSE161731)$cohort)

# Eliminem duplicats
counts_key_sense_dup<-counts_key[!duplicated(counts_key$subject_id),]
rna_ids_sense_dup<-counts_key_sense_dup$rna_id
SE_GSE161731<-SE_GSE161731[,colnames(SE_GSE161731) %in% rna_ids_sense_dup]
table(duplicated(counts_key_sense_dup$subject_id))  # Ha de donar FALSE
dim(SE_GSE161731)
ncol(SE_GSE161731)

# Definim el format de les variables
counts_key$age<-as.numeric(counts_key$age)
counts_key$gender<-as.factor(counts_key$gender)
levels(counts_key$gender)
counts_key$race<-gsub("[ /-]","_",counts_key$race)
counts_key$race<-as.factor(counts_key$race)
levels(counts_key$race)
counts_key$cohort<-as.factor(counts_key$cohort)
levels(counts_key$cohort)
counts_key$time_since_onset<-as.factor(counts_key$time_since_onset)
levels(counts_key$time_since_onset)
counts_key$hospitalized<-as.factor(counts_key$hospitalized)
levels(counts_key$hospitalized)
str(counts_key)

# Seleccionem 75 mostres utilitzant una llavor determinada
myseed<-sum(utf8ToInt("martornefarre"))
set.seed(myseed)
mostres_sel<-sample(colnames(SE_GSE161731),75)
mostres_sel
SE_GSE161731<-SE_GSE161731[,colnames(SE_GSE161731) %in% mostres_sel]
dim(SE_GSE161731)
```




En primer lloc descarreguem els fitxers i els guardem al repositori **GitHub** que hem creat per emmagatzemar tota la documentació del projecte.

```{r,message=FALSE,warning=FALSE,eval=TRUE,echo=TRUE}

```

## Construcció d'un objecte de classe SummarizedExperiment

A continuació, creem un objecte de classe **SummarizedExperiment** amb les dades i metadades de l'estudi. Realitzem diferents transformacions i adaptacions als fitxers per assegurar-nos que els camps comuns siguin iguals i estiguin en el mateix ordre en les bases de dades. A més, ajustarem alguns formats, com ara transformar els camps de **features** a valors numèrics.

```{r,message=FALSE,warning=FALSE,eval=TRUE,echo=TRUE}

```




## Anàlisi exploratori




```{r,message=FALSE,warning=FALSE,eval=TRUE,echo=TRUE}
# Resum estadístic de les dades
#summary(assay(object_se))  

# Eliminem els metabòlits amb tots els valors a NA, n'hi han 182
metabolits_NA<-apply(assay(object_se),1,function(x) all(is.na(x)))
object_se<-object_se[!metabolits_NA,]

# Un metabòlit té nom UNKNOWN
cat("Metabòlits sense nom assignat\n")
rownames(object_se)[rownames(object_se)=="UNKNOWN"]<-"99999"
sum(rownames(object_se)=="99999")

# Substituïm els zeros pel valor mínim/2 corresponent a cada fila
assay_data<-assay(object_se)
min_values<-apply(assay_data,1,function(x) ifelse(all(x==0|is.na(x)),NA,min(x[x>0], na.rm=TRUE)/2))
for (i in seq_len(nrow(assay_data))){
  assay_data[i,assay_data[i,]==0]<-min_values[i]
}
assay(object_se)<-assay_data

# Normalitzem les dades per Z-score 
assay(object_se)<-scale(assay(object_se))

# Guardem l'objecte SummarizedExperiment
save(object_se,file="object_se.Rda")
#load("object_se.Rda")
```

Guardem **objecte_es** en format **Rda** al repositori. Aquest és un tipus de format binari utilitzat per R per emmagatzemar objectes en un fitxer que després es pot carregar fàcilment a la memòria. Aquest format permet desar un o més objectes a la vegada i preservar-ne l’estructura i les metadades.

## Anàlisi exploratori amb POMA

```{r,message=FALSE,warning=FALSE,eval=TRUE,echo=TRUE}
# Instal·lem Bioconductor 
#if (!require("BiocManager", quietly = TRUE))
#  install.packages("BiocManager")

# Instal·lem POMA
#BiocManager::install("POMA")

library(POMA)
library(ggtext)
library(magrittr)
library(ggplot2)

# Creem un objecte SummarizedExperiment de dos bases de dades separades
features_t<-t(features)  # Trasposem perquè POMA vol la matriu de dades al revés
cat("Dimensions dels datasets\n")
dim(metadata)
dim(features_t)
object_POMA<-PomaCreateObject(metadata=metadata,features=features_t)

# Eliminem els metabòlits amb tots els valors NA i imputem
cat("Valors perduts\n")
sum(is.na(SummarizedExperiment::assay(object_POMA)))
metabolits_NA<-apply(assay(object_POMA),1,function(x) all(is.na(x)))
object_POMA<-object_POMA[!metabolits_NA,]
object_POMA<-PomaImpute(object_POMA,zeros_as_na=FALSE,remove_na=TRUE,cutoff=20,method="knn")
#assay(object_POMA)

# Normalitzem les dades
object_POMA_norm<-PomaNorm(object_POMA,sample_norm="none",method="log_pareto")

# Representem l'efecte de la normalització
PomaBoxplots(object_POMA,x="samples")
PomaDensity(object_POMA,x="features")+ggplot2::theme(legend.position="none")
PomaBoxplots(object_POMA_norm,x="samples")
PomaDensity(object_POMA_norm,x="features")+ggplot2::theme(legend.position="none")

# Revisem els outliers
outlier_results<-PomaOutliers(object_POMA_norm)
print(outlier_results)

# Obtenim un objecte pre-processat sense outlier
pre_processed_object_POMA<-PomaOutliers(object_POMA_norm)$data

# Visualitzem els outliers
PomaOutliers(pre_processed_object_POMA)$polygon_plot
```



## Anàlisi complementari amb POMA

```{r,message=FALSE,warning=FALSE,eval=TRUE,echo=TRUE}
# Anàlisi de Components Principals (PCA) 
PomaPCA(pre_processed_object_POMA,outcome=NULL,center=TRUE,scale=TRUE,ncomp=4,labels=FALSE,ellipse=FALSE,load_length=1)

# Anàlisi de Clústers
PomaClust(pre_processed_object_POMA,method="euclidean",k=NA,k_max=floor(min(dim(data))/2),show_clusters=TRUE,labels=FALSE)

# Gràfic Heatmap
PomaHeatmap(pre_processed_object_POMA,covs=NULL,sample_names=TRUE,feature_names=FALSE,show_legend=TRUE)
```



# Discussió


# Conclusions


# Referències

L'enllaç al repositori de **GitHub** que conté tota la documentació del projecte és:

https://github.com/MarTorne/Torne-Farre-Mar-PEC2.git
